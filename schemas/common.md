# Common Contracts

This document defines shared schemas, headers, enums, and error formats
used across GAPI and Pulse Service.

No endpoints are defined here.

---

## Common Headers

### Request Headers

#### Required (GAPI)
- `Content-Type: application/json`

#### Optional (Tracing)
- `X-Request-Id: <uuid>` - Unique request identifier
- `X-Trace-Id: <uuid>` - Distributed trace identifier

If not provided, these will be auto-generated by the middleware.

### Response Headers

All responses MUST include tracing headers:

- `X-Request-Id: <uuid>` - Request identifier (generated or echoed from request)
- `X-Trace-Id: <uuid>` - Trace identifier (generated or echoed from request)

---

## Common Enums

### OrderSide

Valid values for order side (buy or sell):

```
BUY
SELL
```

### OrderQueueStatus

Status values for the order splitting lifecycle (parent order only):

```
PENDING
IN_PROGRESS
DONE
SKIPPED
```

### OrderSliceStage

Stages for an individual order slice (formerly “child order”):

```
SCHEDULED
IN_PROGRESS
PROCESSED
```

Note:
- “Order” always refers to the parent order.
- “OrderSlice” refers to the scheduled/placed unit derived from the parent order.

---

## Common Schemas

### SplitConfig

Configuration for splitting an order:

```json
{
  "num_splits": 5,
  "duration_minutes": 60,
  "randomize": true
}
```

**Fields**:
- `num_splits` (integer, required): Number of child orders to create
  - Min: 2
  - Max: 100
- `duration_minutes` (integer, required): Total duration in minutes
  - Min: 1
  - Max: 1440 (24 hours)
- `randomize` (boolean, optional): Whether to apply randomization
  - Default: true

---

## Error Format

All errors MUST follow this structure:

```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "Human-readable error message",
    "details": {}
  }
}
```

**Note**: Tracing information (`request_id`, `trace_id`) is returned in response headers (`X-Request-Id`, `X-Trace-Id`), not in the error body.

### Error Codes

#### Validation Errors (4xx)

- `INVALID_REQUEST` - Malformed request body or missing required fields
- `INVALID_INSTRUMENT` - Invalid instrument format or unsupported exchange
- `INVALID_QUANTITY` - Invalid quantity (must be > 0 and >= num_splits)
- `INVALID_SPLIT_CONFIG` - Invalid split configuration parameters
- `DUPLICATE_ORDER_UNIQUE_KEY` - Order unique key already used with different data
- `UNAUTHORIZED` - Missing or invalid authentication token

#### Business Errors (4xx)

- `INSUFFICIENT_FUNDS` - Not enough funds to place order
- `MARKET_CLOSED` - Market is currently closed

#### System Errors (5xx)

- `INTERNAL_ERROR` - Unexpected system error
- `DATABASE_ERROR` - Database operation failed
- `BROKER_ERROR` - Broker API error

